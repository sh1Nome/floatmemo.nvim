# floatmemo.nvim 仕様書

## 概要
Neovim のフロートウィンドウにメモを表示・編集するプラグイン。プロジェクトに関わらず同じ場所にメモを保存・管理できる。

## 要件

### 1. 機能要件

#### 1.1 コマンド
- `:FloatmemoOpen` - メモをフロートウィンドウで開く
  - フロートウィンドウが表示されている場合：何もしない
  - ウィンドウが表示されていない場合：新規作成して開く
- `:FloatmemoClose` - フロートウィンドウを閉じる

#### 1.2 フロートウィンドウ
- フロートウィンドウは同時に 1 つだけ表示される
- ウィンドウサイズをカスタマイズ可能
  - デフォルト：幅 80%、高さ 80%
  - ユーザー設定で変更可能
  - パーセンテージで指定し、端末サイズの変更に対応
- ウィンドウ位置を計算して自動配置（画面中央を想定）
- ボーダーを表示（style: "rounded"）

#### 1.3 メモファイル
- 1 つのテキストファイルのみを管理
- ファイル名：`memo.txt`
- ファイルパス：ユーザー設定で指定可能
  - デフォルト：プラグインインストール場所のルート + `/memo.txt`
  - 例：`~/.local/share/nvim/site/pack/packer/start/floatmemo.nvim/memo.txt`
- メモの内容は `memo.txt` に自動保存される
- ウィンドウを再度開く際は、`memo.txt` から最新の内容を読み込む

#### 1.4 閉じるときの動作
- `save_on_close`（デフォルト: true）
  - true の場合：メモ内容をファイルに自動保存してからウィンドウを閉じる
  - false の場合：メモ内容を破棄してウィンドウを閉じる

#### 1.5 複数プロジェクト対応
- どのプロジェクトのディレクトリからでも、同じメモファイルを開く
- メモファイルパスはグローバルで固定

### 2. 技術要件

#### 2.1 実装言語
- Lua のみ（Vimscript 不使用）

#### 2.2 ディレクトリ構造
```
floatmemo.nvim/
├── README.md                    # プラグイン説明
├── SPEC.md                      # このファイル（仕様書）
├── .gitignore                   # memo.txt を追加
├── plugin/
│   └── floatmemo.lua            # エントリポイント（コマンド定義）
├── lua/floatmemo/
│   ├── init.lua                 # メイン処理（open/close ロジック）
│   ├── config.lua               # 設定管理
│   ├── window.lua               # フロートウィンドウ操作
│   ├── storage.lua              # ファイル読み書き
│   └── state.lua                # 状態管理（ウィンドウID等）
└── memo.txt                     # メモファイル（gitignore に追加）
```

#### 2.3 バッファとウィンドウの管理
- バッファ ID でメモバッファを識別
- ウィンドウが開いているかどうかを状態管理
- フロートウィンドウを作成・表示
- バッファを `:ls` やタブラインから非表示
  - `buflisted = false` と `buftype = 'nofile'` を設定

### 3. 設定オプション

```lua
require('floatmemo').setup({
  -- メモファイルのパス（デフォルト: プラグインルート/memo.txt）
  memo_path = nil,  -- nil の場合は自動計算
  
  -- ウィンドウサイズ（0 < value <= 100 でパーセンテージ指定）
  width = 80,   -- デフォルト: 80%
  height = 80,  -- デフォルト: 80%
  
  -- 閉じる時の動作
  save_on_close = true,  -- true: 保存して閉じる、false: 破棄して閉じる
  
  -- UI設定
  border = "rounded",  -- "single", "double", "shadow", "rounded" 等
})
```

### 4. 状態遷移

```
[未作成]
  ↓ :FloatmemoOpen
[ウィンドウ作成・表示、バッファ作成]
  ↓ (ユーザーが編集)
  ↓ :FloatmemoClose
[保存処理実行（設定に応じて）]
  ↓
[ウィンドウ・バッファ削除]
  ↓ :FloatmemoOpen
[ウィンドウ再作成]
```

### 5. エラーハンドリング

- ファイル保存失敗時：エラーメッセージを表示（`:echo` または `vim.notify`）
- メモファイル読み込み失敗時：エラーメッセージを表示（`:echo` または `vim.notify`）

### 6. ユーザーインターフェース

#### 6.1 メッセージ
- エラー：`"Error: [詳細]"`

## 初回実装の進め方

1. `config.lua` - 設定初期化・管理
2. `state.lua` - ウィンドウ/バッファ ID 管理
3. `storage.lua` - ファイル読み書き
4. `window.lua` - フロートウィンドウ作成・表示
5. `init.lua` - 全体の統合
6. `plugin/floatmemo.lua` - コマンド定義、setup 関数公開
7. `.gitignore` - `memo.txt` 追加
8. `README.md` - 使用方法・インストール方法ドキュメント
